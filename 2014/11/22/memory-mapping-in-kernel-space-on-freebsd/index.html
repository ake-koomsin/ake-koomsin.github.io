
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Memory Mapping in Kernel Space on FreeBSD - Ake Koomsin</title>
  <meta name="author" content="Ake Koomsin">

  
  <meta name="description" content="It might sound strange to do some memory mapping in the kernel space. You probably have heard of bpfjit. It is a JIT compiler of filter program sent &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ake.in.th/2014/11/22/memory-mapping-in-kernel-space-on-freebsd">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ake Koomsin" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ake Koomsin</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ake.in.th" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">Memory Mapping in Kernel Space on FreeBSD</h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2014-11-22T13:13:46+09:00" pubdate data-updated="true">Nov 22<span>nd</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>It might sound strange to do some memory mapping in the kernel space. You probably have heard of <a href="http://netbsd.gw.com/cgi-bin/man-cgi?bpfjit+4.pmax+NetBSD-current" title="BPFJIT">bpfjit</a>. It is a JIT compiler of filter program sent to a bpf device. Bpfjit uses <a href="http://sljit.sourceforge.net" title="Stack-Less Just-In-Time library">sljit</a> library for compiling. One requirement of JIT compiler is that the compiled code must reside in executable memory area. Let&rsquo;s take a look at the sljit source code in the NetBSD tree to see how it is done.</p>

<figure class='code'><figcaption><span>In sys/external/bsd/sljit/dist/sljit_src/sljitExecAllocator.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="p">...</span>
</span><span class='line'><span class="k">static</span> <span class="n">SLJIT_INLINE</span> <span class="kt">void</span><span class="o">*</span> <span class="n">alloc_chunk</span><span class="p">(</span><span class="n">sljit_uw</span> <span class="n">size</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="cp">#ifdef _KERNEL</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">uvm_km_alloc</span><span class="p">(</span><span class="n">module_map</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
</span><span class='line'>      <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">UVM_KMF_WIRED</span> <span class="o">|</span> <span class="n">UVM_KMF_ZERO</span> <span class="o">|</span> <span class="n">UVM_KMF_EXEC</span><span class="p">);</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>  <span class="kt">void</span><span class="o">*</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span> <span class="o">|</span> <span class="n">PROT_EXEC</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_ANON</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="o">?</span> <span class="n">retval</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Normally, <code>mmap()</code> is used along with <code>PROT_EXEC</code> and <code>MAP_ANON</code> in user space application to allocate executable memory area. However, in kernel space, it requires another function to do. In NetBSD, <code>uvm_km_alloc()</code> is used with <code>UVM_KMF_EXEC</code> flag to allocate executable memory area. Noting that the <code>UVM_KMF_EXEC</code> flag is not written in the <code>uvm_km_alloc()</code> man page.</p>

<p>However, after spending hours in both source code and man page of FreeBSD, it seems that there is no kernel memory allocation API to allocate executable memory. That makes me read the implementation of <code>mmap()</code>. After studying the source code for a while, it is possible to do memory mapping in the kernel as shown below.</p>

<figure class='code'><figcaption><span>Part of kernel module code example</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">example_syscall</span><span class="p">(</span><span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">td</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">vm_offset_t</span> <span class="n">addr</span><span class="p">;</span>
</span><span class='line'>  <span class="n">vm_size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">pageoff</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">void</span> <span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>  <span class="n">objtype_t</span> <span class="n">handle_type</span> <span class="o">=</span> <span class="n">OBJT_DEFAULT</span><span class="p">;</span>
</span><span class='line'>  <span class="n">vm_prot_t</span> <span class="n">maxprot</span> <span class="o">=</span> <span class="n">VM_PROT_ALL</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">MAP_ANON</span> <span class="o">|</span> <span class="n">MAP_PRIVATE</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">off_t</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">size</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;original size: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm">  * Align the file position to a page boundary,</span>
</span><span class='line'><span class="cm">  * and save its page offset component.</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="n">pageoff</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">);</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;pageoff: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pageoff</span><span class="p">);</span>
</span><span class='line'>  <span class="n">pos</span> <span class="o">-=</span> <span class="n">pageoff</span><span class="p">;</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;pos: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/* Adjust size for rounding (on both ends). */</span>
</span><span class='line'>  <span class="n">size</span> <span class="o">+=</span> <span class="n">pageoff</span><span class="p">;</span>            <span class="cm">/* low end... */</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;size+=pageoff: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span><span class='line'>  <span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">vm_size_t</span><span class="p">)</span> <span class="n">round_page</span><span class="p">(</span><span class="n">size</span><span class="p">);</span> <span class="cm">/* hi end */</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;size after round page: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">vm_mmap</span><span class="p">(</span><span class="n">kernel_map</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">maxprot</span><span class="p">,</span>
</span><span class='line'>            <span class="n">maxprot</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">handle_type</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>   
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">);</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">kernacc</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">VM_PROT_EXECUTE</span><span class="p">);</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;result: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
</span><span class='line'>  <span class="n">vm_map_lock</span><span class="p">(</span><span class="n">kernel_map</span><span class="p">);</span>
</span><span class='line'>  <span class="n">vm_map_delete</span><span class="p">(</span><span class="n">kernel_map</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">size</span><span class="p">);</span>
</span><span class='line'>  <span class="n">vm_map_unlock</span><span class="p">(</span><span class="n">kernel_map</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The result of running this system call is shown below.</p>

<figure class='code'><figcaption><span>Result</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>original size: 80
</span><span class='line'>pageoff: 0
</span><span class='line'>pos: 0
</span><span class='line'>size+=pageoff: 80
</span><span class='line'>size after round page: 4096
</span><span class='line'>result: 1
</span></code></pre></td></tr></table></div></figure>


<p><code>vm_mmap()</code> is an internal implementation of <code>mmap()</code> and <code>vm_map_delete()</code> is an internal implementation of <code>munmap()</code>. The first argument of both <code>vm_map()</code> and <code>vm_map_delete()</code> is the memory area to map. Normally it would be the map of the process virtual memory address space. In this case, it is <code>kernel_map</code> which is a global variable. The important thing is aligning and rounding. Otherwise, it will end up in kernel panic because of page fault. Noting that the aligning and rounding comment in the example are from FreeBSD&rsquo;s <code>sys_mmap()</code> source code.</p>

<p>The <code>kernacc()</code> function is for testing a memory area if it is readable, writable, executable or not. In the example, it tests if the memory area is executable or not. The result is yes. Noting that in the example I specify that the memory is readable, writable and executable through <code>VM_PROT_ALL</code>.</p>

<p>One good thing about using <code>vm_map()</code> for memory allocation is it is possible to change the memory protection easily through <code>vm_map_protect()</code>, the internal implementation of <code>mprotect()</code>. One probably wants the memory to be read and write only during JIT compilation and read and execute only after that for security reason.</p>

<p>And that&rsquo;s all about doing memory mapping in kernel space on FreeBSD. Happy Kernel Hacking!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Ake Koomsin</span></span>

      








  


<time datetime="2014-11-22T13:13:46+09:00" pubdate data-updated="true">Nov 22<span>nd</span>, 2014</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://ake.in.th/2014/11/22/memory-mapping-in-kernel-space-on-freebsd/" data-via="" data-counturl="http://ake.in.th/2014/11/22/memory-mapping-in-kernel-space-on-freebsd/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2014/11/04/verify-openbsd-install-media-from-os-x/" title="Previous Post: Verifing OpenBSD install media on OS X">&laquo; Verifing OpenBSD install media on OS X</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2014/11/22/memory-mapping-in-kernel-space-on-freebsd/">Memory Mapping in Kernel Space on FreeBSD</a>
      </li>
    
      <li class="post">
        <a href="/2014/11/04/verify-openbsd-install-media-from-os-x/">Verifing OpenBSD Install Media on OS X</a>
      </li>
    
      <li class="post">
        <a href="/2014/07/04/digging-around-freebsd-socket-api-tcp-send-path/">Digging Around FreeBSD Socket API TCP Send Path</a>
      </li>
    
      <li class="post">
        <a href="/2013/09/20/thought-on-learning-kanji-with-remembering-the-kanji/">Thought on Learning Kanji With Remembering the Kanji</a>
      </li>
    
      <li class="post">
        <a href="/2013/04/17/building-facebook-home-with-quartz-composer/">Building Facebook Home With Quartz Composer</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Ake Koomsin -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
