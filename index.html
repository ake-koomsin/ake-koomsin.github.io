
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ake Koomsin</title>
  <meta name="author" content="Ake Koomsin">

  
  <meta name="description" content="Assuming that you are using us.iso.kbd keymap, you can remap CAPSLOCK to CTRL by this simple following steps. First, copy the us.iso.kbd 1
2
# cd / &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ake.in.th">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ake Koomsin" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ake Koomsin</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ake.in.th" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
      <h1 class="entry-title"><a href="/2015/04/17/remap-capslock-to-ctrl-on-freebsd/">Remap CAPSLOCK to CTRL on FreeBSD</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2015-04-17T15:36:35+09:00" pubdate data-updated="true">Apr 17<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Assuming that you are using <code>us.iso.kbd</code> keymap, you can remap CAPSLOCK to CTRL by this simple following steps.</p>

<p>First, copy the <code>us.iso.kbd</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># cd /usr/share/syscons/keymaps/
</span><span class='line'># cp us.iso.kbd us.iso-swap.kbd
</span></code></pre></td></tr></table></div></figure>


<p>Next, modify the permission of <code>us.iso-swap.kbd</code> to be writable.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># chmod 644 us.iso-swap.kbd
</span></code></pre></td></tr></table></div></figure>


<p>Then, modify <code>us.iso-swap.kbd</code>. Look at the line with number 058 and change &ldquo;clock&rdquo; to &ldquo;lctrl&rdquo; like this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>...
</span><span class='line'>058   lctrl  lctrl  lctrl  lctrl  lctrl  lctrl  lctrl  lctrl   O
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>After that, change the permission back to read-only</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'># chmod 444 us.iso-swap.kbd
</span></code></pre></td></tr></table></div></figure>


<p>Finally, add this text to <code>/etc/rc.conf</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>keymap=&quot;us.iso-swap&quot;
</span></code></pre></td></tr></table></div></figure>


<p>Reboot and now your CAPLOCKS will be CTRL.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
      <h1 class="entry-title"><a href="/2015/02/04/seeing-all-pages-available-in-section-9-on-freebsd/">Seeing All Man Pages Available in a Section on FreeBSD</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2015-02-04T18:19:47+09:00" pubdate data-updated="true">Feb 4<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When I am working with a kernel module in FreeBSD, there are times that I want to see all functions available in <code>man 9</code>.
I know that <code>apropos</code> is out there but I sometimes don&rsquo;t know the keyword.</p>

<p>Because of this, I decided to write a simple zsh script to list all available pages in a section, not only in section 9.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>function ls_man() {
</span><span class='line'>    if [[ $# -ne 1 ]]; then
</span><span class='line'>        echo &quot;Number of argument must be 1&quot; &gt;&amp;2
</span><span class='line'>        echo &quot;Usage: ls_man [1-9]&quot; &gt;&amp;2
</span><span class='line'>        return 1
</span><span class='line'>    fi
</span><span class='line'>
</span><span class='line'>    if [[ $1 == [1-9] ]]; then
</span><span class='line'>        ls /usr/share/man/man$1 | awk &#39;{ split($1, name, &quot;.&quot;) } { print name[1] }&#39;
</span><span class='line'>        return 0
</span><span class='line'>    else
</span><span class='line'>        echo &quot;Wrong argument&quot; &gt;&amp;2
</span><span class='line'>        echo &quot;Usage: ls_man [1-9]&quot; &gt;&amp;2
</span><span class='line'>        return 1
</span><span class='line'>    fi
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
      <h1 class="entry-title"><a href="/2014/11/04/verify-openbsd-install-media-from-os-x/">Verifing OpenBSD Install Media on OS X</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2014-11-04T20:07:13+09:00" pubdate data-updated="true">Nov 4<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>New <a href="http://www.openbsd.org/56.html">OpenBSD 5.6</a> has been released. It is time to give it a try.</p>

<p>In the installation maunal, There is a section &ldquo;Verifying the OpenBSD Installation Media&rdquo;. <code>signify</code> command is used for verification.</p>

<figure class='code'><figcaption><span>Verifying the install media</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>signify -C -p /etc/signify/openbsd-56-base.pub -x SHA256.sig cd56.iso
</span></code></pre></td></tr></table></div></figure>


<p>The <code>SHA256.sig</code> and <code>cd56.iso</code> can be obtained from the mirror. However, <code>openbsd-56-base.pub</code> file is not available. In addition, there is no <code>signify</code> in default OS X installation.</p>

<p>To use <code>signify</code> to verify the install media, we can do the following:</p>

<p>1) Install <code>signify</code> from either <code>port</code> or <code>homebrew</code>.</p>

<figure class='code'><figcaption><span>Install signify from homebrew</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>brew install signify-osx
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>2) Copy the public key from <a href="http://www.openbsd.org/56.html">http://www.openbsd.org/56.html</a> and create a file to store the key. It is required that the file must start with &ldquo;untrusted comment: &rdquo;.</p>

<figure class='code'><figcaption><span>56.pub</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>untrusted comment: signify public key for OpenBSD 5.6
</span><span class='line'>RWR0EANmo9nqhpPbPUZDIBcRtrVcRwQxZ8UKGWY8Ui4RHi229KFL84wV
</span></code></pre></td></tr></table></div></figure>


<p>3) Verify. In my case, I verify the <code>install56.fs</code> which is for creating bootable USB. In my case, every file is in the same directory.</p>

<figure class='code'><figcaption><span>Verify</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>signify -C -p 56.pub -x SHA256.sig install56.fs
</span></code></pre></td></tr></table></div></figure>


<p>The final result should look like this.</p>

<figure class='code'><figcaption><span>Final result</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Signature Verified
</span><span class='line'>install56.fs: OK
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
      <h1 class="entry-title"><a href="/2014/07/04/digging-around-freebsd-socket-api-tcp-send-path/">Digging Around FreeBSD Socket API TCP Send Path</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2014-07-04T00:08:26+09:00" pubdate data-updated="true">Jul 4<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When we want to send data across network, it involves either</p>

<ul>
<li><code>write()/writev()</code></li>
<li><code>send()/sendto()/sendmsg()</code></li>
</ul>


<p>and sockets.</p>

<p>To use <code>write()</code>, <code>writev()</code> and <code>send()</code>, the socket must be connected. On the other hand <code>sendto()</code> and <code>sendmsg()</code> can be used in both connected and unconnected connection.</p>

<p>We normally can find the implementation of system calls in the kernel by adding ‘sys_’ prefix to the name of the system call except <code>send()</code>. In FreeBSD libc, <code>send()</code> is just a wrapper of <code>sendto()</code> with some default parameters.</p>

<p>Let’s take a look at <code>sys_write()</code>.</p>

<figure class='code'><figcaption><span>In sys/kern/sys_generic.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="n">sys_write</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">uap</span><span class="p">)</span>
</span><span class='line'>    <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">write_args</span> <span class="o">*</span><span class="n">uap</span><span class="p">;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">uio</span> <span class="n">auio</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">iovec</span> <span class="n">aiov</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">uap</span><span class="o">-&gt;</span><span class="n">nbyte</span> <span class="o">&gt;</span> <span class="n">IOSIZE_MAX</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
</span><span class='line'>  <span class="n">aiov</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">uap</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
</span><span class='line'>  <span class="n">aiov</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">uap</span><span class="o">-&gt;</span><span class="n">nbyte</span><span class="p">;</span>
</span><span class='line'>  <span class="n">auio</span><span class="p">.</span><span class="n">uio_iov</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aiov</span><span class="p">;</span>
</span><span class='line'>  <span class="n">auio</span><span class="p">.</span><span class="n">uio_iovcnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="n">auio</span><span class="p">.</span><span class="n">uio_resid</span> <span class="o">=</span> <span class="n">uap</span><span class="o">-&gt;</span><span class="n">nbyte</span><span class="p">;</span>
</span><span class='line'>  <span class="n">auio</span><span class="p">.</span><span class="n">uio_segflg</span> <span class="o">=</span> <span class="n">UIO_USERSPACE</span><span class="p">;</span>
</span><span class='line'>  <span class="n">error</span> <span class="o">=</span> <span class="n">kern_writev</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">uap</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">auio</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It is just a special form of <code>writev()</code> as it calls <code>kern_writev()</code> eventually. Taking a look at <code>kern_writev()</code> gives us some interesting code pattern.</p>

<figure class='code'><figcaption><span>In sys/kern/sys_generic.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">kern_writev</span><span class="p">(</span><span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">td</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uio</span> <span class="o">*</span><span class="n">auio</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
</span><span class='line'>    <span class="n">cap_rights_t</span> <span class="n">rights</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">error</span> <span class="o">=</span> <span class="n">fget_write</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">cap_rights_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rights</span><span class="p">,</span> <span class="n">CAP_WRITE</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">fp</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">);</span>
</span><span class='line'>    <span class="n">error</span> <span class="o">=</span> <span class="n">dofilewrite</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">auio</span><span class="p">,</span> <span class="p">(</span><span class="kt">off_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">fdrop</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>fget_write()</code> is called to verify that we have permission to perform write operation and get a pointer to the file associated with the file descriptor. After thus function call, the reference count of the file is increased. That is why in the end <code>fdrop()</code> macro is called to decrease the reference count and perform some cleanup if necessary.</p>

<p>The write operation happens when <code>dofilewrite()</code> is called.</p>

<figure class='code'><figcaption><span>In sys/kern/sys_generic.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="n">dofilewrite</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">auio</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
</span><span class='line'>    <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">uio</span> <span class="o">*</span><span class="n">auio</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">off_t</span> <span class="n">offset</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>      <span class="p">...</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">fo_write</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">auio</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">td_ucred</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">td</span><span class="p">)))</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>      <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>dofilewrite()</code> performs some verification and dispatches write operating to an appropriate function by calling <code>fo_write()</code>. The real write function depends on the type of the file.</p>

<figure class='code'><figcaption><span>In sys/sys/file.h</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kr">__inline</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">fo_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uio</span> <span class="o">*</span><span class="n">uio</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ucred</span> <span class="o">*</span><span class="n">active_cred</span><span class="p">,</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="p">((</span><span class="o">*</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">f_ops</span><span class="o">-&gt;</span><span class="n">fo_write</span><span class="p">)(</span><span class="n">fp</span><span class="p">,</span> <span class="n">uio</span><span class="p">,</span> <span class="n">active_cred</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">td</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>For socket, file operations are defined as follows.</p>

<figure class='code'><figcaption><span>In sys/kern/sys_socket.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">fileops</span>    <span class="n">socketops</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">.</span><span class="n">fo_read</span> <span class="o">=</span> <span class="n">soo_read</span><span class="p">,</span>
</span><span class='line'>    <span class="p">.</span><span class="n">fo_write</span> <span class="o">=</span> <span class="n">soo_write</span><span class="p">,</span>
</span><span class='line'>    <span class="p">.</span><span class="n">fo_truncate</span> <span class="o">=</span> <span class="n">soo_truncate</span><span class="p">,</span>
</span><span class='line'>    <span class="p">.</span><span class="n">fo_ioctl</span> <span class="o">=</span> <span class="n">soo_ioctl</span><span class="p">,</span>
</span><span class='line'>    <span class="p">.</span><span class="n">fo_poll</span> <span class="o">=</span> <span class="n">soo_poll</span><span class="p">,</span>
</span><span class='line'>    <span class="p">.</span><span class="n">fo_kqfilter</span> <span class="o">=</span> <span class="n">soo_kqfilter</span><span class="p">,</span>
</span><span class='line'>    <span class="p">.</span><span class="n">fo_stat</span> <span class="o">=</span> <span class="n">soo_stat</span><span class="p">,</span>
</span><span class='line'>    <span class="p">.</span><span class="n">fo_close</span> <span class="o">=</span> <span class="n">soo_close</span><span class="p">,</span>
</span><span class='line'>    <span class="p">.</span><span class="n">fo_chmod</span> <span class="o">=</span> <span class="n">invfo_chmod</span><span class="p">,</span>
</span><span class='line'>    <span class="p">.</span><span class="n">fo_chown</span> <span class="o">=</span> <span class="n">invfo_chown</span><span class="p">,</span>
</span><span class='line'>    <span class="p">.</span><span class="n">fo_sendfile</span> <span class="o">=</span> <span class="n">invfo_sendfile</span><span class="p">,</span>
</span><span class='line'>    <span class="p">.</span><span class="n">fo_flags</span> <span class="o">=</span> <span class="n">DFLAG_PASSABLE</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>That means the actual write function is <code>soo_write()</code>.</p>

<figure class='code'><figcaption><span>In sys/kern/sys_socket.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">soo_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uio</span> <span class="o">*</span><span class="n">uio</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ucred</span> <span class="o">*</span><span class="n">active_cred</span><span class="p">,</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">so</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">f_data</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#ifdef MAC</span>
</span><span class='line'>    <span class="n">error</span> <span class="o">=</span> <span class="n">mac_socket_check_send</span><span class="p">(</span><span class="n">active_cred</span><span class="p">,</span> <span class="n">so</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>    <span class="n">error</span> <span class="o">=</span> <span class="n">sosend</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">uio</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">uio</span><span class="o">-&gt;</span><span class="n">uio_td</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="n">EPIPE</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">so</span><span class="o">-&gt;</span><span class="n">so_options</span> <span class="o">&amp;</span> <span class="n">SO_NOSIGPIPE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">PROC_LOCK</span><span class="p">(</span><span class="n">uio</span><span class="o">-&gt;</span><span class="n">uio_td</span><span class="o">-&gt;</span><span class="n">td_proc</span><span class="p">);</span>
</span><span class='line'>        <span class="n">tdsignal</span><span class="p">(</span><span class="n">uio</span><span class="o">-&gt;</span><span class="n">uio_td</span><span class="p">,</span> <span class="n">SIGPIPE</span><span class="p">);</span>
</span><span class='line'>        <span class="n">PROC_UNLOCK</span><span class="p">(</span><span class="n">uio</span><span class="o">-&gt;</span><span class="n">uio_td</span><span class="o">-&gt;</span><span class="n">td_proc</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Again, <code>soo_write()</code> performs some necessary verification and calls <code>sosend()</code>.</p>

<p>Before we go further, let’s take a look at <code>sys_sendt()</code> to see how it differs from normal <code>write()</code> system call.</p>

<figure class='code'><figcaption><span>In sys/kern/uipc_syscalls.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="n">sys_sendto</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">uap</span><span class="p">)</span>
</span><span class='line'>    <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">sendto_args</span> <span class="cm">/* {</span>
</span><span class='line'><span class="cm">        int s;</span>
</span><span class='line'><span class="cm">        caddr_t buf;</span>
</span><span class='line'><span class="cm">        size_t  len;</span>
</span><span class='line'><span class="cm">        int flags;</span>
</span><span class='line'><span class="cm">        caddr_t to;</span>
</span><span class='line'><span class="cm">        int tolen;</span>
</span><span class='line'><span class="cm">    } */</span> <span class="o">*</span><span class="n">uap</span><span class="p">;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msg</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">iovec</span> <span class="n">aiov</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">msg</span><span class="p">.</span><span class="n">msg_name</span> <span class="o">=</span> <span class="n">uap</span><span class="o">-&gt;</span><span class="n">to</span><span class="p">;</span>
</span><span class='line'>    <span class="n">msg</span><span class="p">.</span><span class="n">msg_namelen</span> <span class="o">=</span> <span class="n">uap</span><span class="o">-&gt;</span><span class="n">tolen</span><span class="p">;</span>
</span><span class='line'>    <span class="n">msg</span><span class="p">.</span><span class="n">msg_iov</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aiov</span><span class="p">;</span>
</span><span class='line'>    <span class="n">msg</span><span class="p">.</span><span class="n">msg_iovlen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="n">msg</span><span class="p">.</span><span class="n">msg_control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="cp">#ifdef COMPAT_OLDSOCK</span>
</span><span class='line'>    <span class="n">msg</span><span class="p">.</span><span class="n">msg_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>    <span class="n">aiov</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">uap</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
</span><span class='line'>    <span class="n">aiov</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">uap</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span><span class="n">sendit</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">uap</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">uap</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>sys_sendmsg()</code> is similar to <code>sys_sendto()</code>. They just handle the arguments differently. They both call <code>sendit()</code> at the end. <code>sendit()</code> performs some check and call <code>kern_sendit()</code> which call <code>sosend()</code> eventually.</p>

<figure class='code'><figcaption><span>In sys/kern/uipc_syscalls.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="n">sendit</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
</span><span class='line'>    <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="n">error</span> <span class="o">=</span> <span class="n">kern_sendit</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">UIO_USERSPACE</span><span class="p">);</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="n">kern_sendit</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">mp</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">segflg</span><span class="p">)</span>
</span><span class='line'>    <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">mbuf</span> <span class="o">*</span><span class="n">control</span><span class="p">;</span>
</span><span class='line'>    <span class="k">enum</span> <span class="n">uio_seg</span> <span class="n">segflg</span><span class="p">;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="n">error</span> <span class="o">=</span> <span class="n">sosend</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">auio</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>sosend()</code> is a basically a wrapper of the function pointed by <code>pru_sosend</code>.</p>

<figure class='code'><figcaption><span>In sys/kern/uipc_socket.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">sosend</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">so</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uio</span> <span class="o">*</span><span class="n">uio</span><span class="p">,</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">mbuf</span> <span class="o">*</span><span class="n">top</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mbuf</span> <span class="o">*</span><span class="n">control</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">CURVNET_SET</span><span class="p">(</span><span class="n">so</span><span class="o">-&gt;</span><span class="n">so_vnet</span><span class="p">);</span>
</span><span class='line'>    <span class="n">error</span> <span class="o">=</span> <span class="n">so</span><span class="o">-&gt;</span><span class="n">so_proto</span><span class="o">-&gt;</span><span class="n">pr_usrreqs</span><span class="o">-&gt;</span><span class="n">pru_sosend</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">uio</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span>
</span><span class='line'>        <span class="n">control</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span>
</span><span class='line'>    <span class="n">CURVNET_RESTORE</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point, the actual function depends on the protocol type. In case of TCP, the <code>pru_sosend</code> points to <code>sosend_generic()</code> (This is the default value. UDP has its own <code>sosend_dgram()</code>).</p>

<figure class='code'><figcaption><span>In sys/kern/uipc_generic.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">sosend_generic</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">so</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uio</span> <span class="o">*</span><span class="n">uio</span><span class="p">,</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">mbuf</span> <span class="o">*</span><span class="n">top</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mbuf</span> <span class="o">*</span><span class="n">control</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">long</span> <span class="n">space</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">ssize_t</span> <span class="n">resid</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">clen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">dontroute</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">atomic</span> <span class="o">=</span> <span class="n">sosendallatonce</span><span class="p">(</span><span class="n">so</span><span class="p">)</span> <span class="o">||</span> <span class="n">top</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>            <span class="cm">/*</span>
</span><span class='line'><span class="cm">             * XXX all the SBS_CANTSENDMORE checks previously</span>
</span><span class='line'><span class="cm">             * done could be out of date.  We could have recieved</span>
</span><span class='line'><span class="cm">             * a reset packet in an interrupt or maybe we slept</span>
</span><span class='line'><span class="cm">             * while doing page faults in uiomove() etc.  We</span>
</span><span class='line'><span class="cm">             * could probably recheck again inside the locking</span>
</span><span class='line'><span class="cm">             * protection here, but there are probably other</span>
</span><span class='line'><span class="cm">             * places that this also happens.  We must rethink</span>
</span><span class='line'><span class="cm">             * this.</span>
</span><span class='line'><span class="cm">             */</span>
</span><span class='line'>            <span class="n">VNET_SO_ASSERT</span><span class="p">(</span><span class="n">so</span><span class="p">);</span>
</span><span class='line'>            <span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">so</span><span class="o">-&gt;</span><span class="n">so_proto</span><span class="o">-&gt;</span><span class="n">pr_usrreqs</span><span class="o">-&gt;</span><span class="n">pru_send</span><span class="p">)(</span><span class="n">so</span><span class="p">,</span>
</span><span class='line'>                <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_OOB</span><span class="p">)</span> <span class="o">?</span> <span class="n">PRUS_OOB</span> <span class="o">:</span>
</span><span class='line'>     <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>At some point in <code>sosend_generic()</code>, <code>pru_send</code> function pointer is called. For TCP, this points to function <code>tcp_user_send()</code>.</p>

<figure class='code'><figcaption><span>In sys/netinet/tcp_usrreq.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">tcp_usr_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">so</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mbuf</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">nam</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mbuf</span> <span class="o">*</span><span class="n">control</span><span class="p">,</span> <span class="k">struct</span> <span class="kr">thread</span> <span class="o">*</span><span class="n">td</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>        <span class="n">tp</span><span class="o">-&gt;</span><span class="n">snd_up</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">snd_una</span> <span class="o">+</span> <span class="n">so</span><span class="o">-&gt;</span><span class="n">so_snd</span><span class="p">.</span><span class="n">sb_cc</span><span class="p">;</span>
</span><span class='line'>        <span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_flags</span> <span class="o">|=</span> <span class="n">TF_FORCEDATA</span><span class="p">;</span>
</span><span class='line'>        <span class="n">error</span> <span class="o">=</span> <span class="n">tcp_output</span><span class="p">(</span><span class="n">tp</span><span class="p">);</span>
</span><span class='line'>        <span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TF_FORCEDATA</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The data is passed to <code>tcp_output()</code> to figure out what to be sent and send it to lower layer by <code>ip_output()</code>.</p>

<figure class='code'><figcaption><span>In sys/netinet/tcp_output.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">tcp_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">tcpcb</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>        <span class="n">TCP_PROBE5</span><span class="p">(</span><span class="n">send</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">th</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">error</span> <span class="o">=</span> <span class="n">ip_output</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_inpcb</span><span class="o">-&gt;</span><span class="n">inp_options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ro</span><span class="p">,</span>
</span><span class='line'>            <span class="p">((</span><span class="n">so</span><span class="o">-&gt;</span><span class="n">so_options</span> <span class="o">&amp;</span> <span class="n">SO_DONTROUTE</span><span class="p">)</span> <span class="o">?</span> <span class="n">IP_ROUTETOIF</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>            <span class="n">tp</span><span class="o">-&gt;</span><span class="n">t_inpcb</span><span class="p">);</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Eventually, the data in mbuf will be passed to the device driver through <code>ifp-&gt;if_output</code> function pointer.</p>

<figure class='code'><figcaption><span>In sys/netinet/ip_output.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span>
</span><span class='line'><span class="nf">ip_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">mbuf</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mbuf</span> <span class="o">*</span><span class="n">opt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">route</span> <span class="o">*</span><span class="n">ro</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">ip_moptions</span> <span class="o">*</span><span class="n">imo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inpcb</span> <span class="o">*</span><span class="n">inp</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * Reset layer specific mbuf flags</span>
</span><span class='line'><span class="cm">         * to avoid confusing lower layers.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="n">m_clrprotoflags</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
</span><span class='line'>        <span class="n">IP_PROBE</span><span class="p">(</span><span class="n">send</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">ifp</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>        <span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ifp</span><span class="o">-&gt;</span><span class="n">if_output</span><span class="p">)(</span><span class="n">ifp</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span>
</span><span class='line'>            <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">gw</span><span class="p">,</span> <span class="n">ro</span><span class="p">);</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In conclusion, sending data across network is not a trivial task. The data from user application will pass through a series of layers. Each layer has its own responsibility.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
      <h1 class="entry-title"><a href="/2013/09/20/thought-on-learning-kanji-with-remembering-the-kanji/">Thought on Learning Kanji With Remembering the Kanji</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-09-20T14:17:00+09:00" pubdate data-updated="true">Sep 20<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>First of all, I would like to apologize that I haven&rsquo;t updated this blog for a very long time. After I graduated in March, I took a little break and started a full-time job on April. I worked on a lot of interesting projects. I cannot share what I worked on because I feel like it is a company secret. In May, I got a notification of acceptance from the University of Tsukuba as a scholarship research student. Therefore, I quited working on June to prepare studying Japanese.</p>

<p>Everyone who studies Japanese language will know that one of the most troublesome aspect, apart from formality, is Kanji. Kanji is derived from Chinese characters. For more information about the history of Kanji, please visit this <a href="http://www.tofugu.com/2010/03/22/the-history-of-kanji/" title="History of Kanji">blog</a>. The author knows how to make it fun. There are more than 3000 Kanji characters as far as I know. Fortunately, may be, there are 2200 Kanji characters that are considered &ldquo;Frequently Used Kanji (Jouyou Kanji 常用漢字)&rdquo; However, Kanji in daily life is going to be lower than that but there is still a lot. There is no wonder why Japanese students spend 12 years in schools to learn all necessary Kanji.</p>

<h2>Things you will encounter when you learn Kanji</h2>

<p>To me, there are 3 things that you will deal with when you learn Kanji which are:</p>

<p>Reading &ndash; Most of the time, there are 2 ways of reading a Kanji. There are Kun-yomi (訓読み) and On-yomi (音読み). Kun-yomi is a Japanese style of reading while On-yomi is a Chinese style of reading. Therefore, in most case, there will be at least 2 sounds that you have to know. The sound may also change according to the surroundings. Some characters have the same reading sound.</p>

<p>Meaning &ndash; Each character has its own meaning, at least one. Well, you have to remember them. There is no other way around. Some characters are synonymous and this can be a little confusing.</p>

<p>Writing &ndash; This is the most discouraging part. Each Kanji character has its own shape with different numbers of strokes. It is very common to forget how to write. Even native speakers sometimes encounter this problem.</p>

<p>As you can see, Kanji alone has a bunch of things to learn. It is considered difficult in the sense that there is a lot and you have to be consistent in learning and reviewing. Self-disciplining is hard, you know. This brings us the question, how should we learn it?</p>

<h2>Traditional way of learning Kanji for foreigners</h2>

<p>If you go to a Japanese language school, the order of Kanji that they will teach you is based on the Japanese Proficiency Test (JLPT). In order words, the Kanji is taught based on the frequency and the complexity of the meaning. You are probably be taught how to read including some of its compounds and are assigned to write each Kanji for hundreds times believing that you will be able to remember how to write them.</p>

<p>In addition, some Kanji characters may be taught by pictographs, transform picture to character. Unfortunately, not all Kanji can be learned using pictographs.</p>

<p>This approach is good from a perspective that you will be able to learn what are necessary for real life early. My opinion is that it is good for those who are busy. Teaching based on frequency and meaning complexity allows you to be able to access Japanese literatures faster.</p>

<p>However, as the number of Kanji grows, it is undoubtedly easy to forget the meaning and, especially, the writing. Those who used to study Japanese will be familiar with this kind of experience. This has hindered many Japanese learner greatly. However, I don&rsquo;t think that reading will be a problem. As mentioned earlier, reading of a Kanji is often based on the surroundings. Learners will usually get used to them eventually.</p>

<p>I want to remind that we are unlike the native that they have seen these Kanji characters since they were born and constantly used them. The way the language school teaches is almost identical to how native Japaneses learn in their schools; 12 years remember!.</p>

<p>This probably means that this approach is not efficient for us, foreigners.</p>

<h2>Alternative approach</h2>

<p>Fortunately, another way to learn Kanji exists. It is called &ldquo;mnemonic approach&rdquo;. The fundamental idea of this approach is that it breaks a Kanji character into smaller parts called &ldquo;primitives&rdquo; or &ldquo;radicals&rdquo; depending on what you prefer (I will go with radical). Those radicals are named and are used to construct a &ldquo;story&rdquo; using your imagination to help you remember those Kanji.</p>

<p>I decide to go with this approach using one of the most controversial book, &ldquo;<a href="http://www.amazon.com/Remembering-Kanji-Volume-Complete-Characters/dp/0824835921" title="Remembering the Kanji 1">Remembering the Kanji 1</a>&rdquo;.</p>

<h2>Remembering the Kanji (RTK)</h2>

<p>&ldquo;Remembering the Kanji&rdquo; is a series of 3 books for studying Kanji written by James W. Heisig. The first book is the most popular one. In the 6th edition, it offers 2200 Kanji characters along with learning approach. The second book teaches you how to read those Kanji. The last book offers another additional 965 Kanji characters for advanced learners. This blog post is about &ldquo;Remembering the Kanji 1 (RTK1)&rdquo;.</p>

<p>Heisig will explain why it is better to use mnemonic approach and his motivation in the introduction part of RTK1. You should not skip this part. Each Kanji will be assigned by with a unique keyword without any pronunciation (you will learn in RTK2). The author believes that it is more efficient to separate writing and meaning from reading and make it easier to study. Heisig organizes the book into 3 parts; stories, plots and elements. The first part will give you radicals, show you how to remember the writing and meaning with those radicals. Noting that a Kanji character itself can also serve as a radical. The purpose of the first part is to train the reader how to create and appreciate the story. The second part will give you only a plot leaving the full story as you exercise. The last part will give you only elements of the Kanji. It is the reader&rsquo;s job to fill up the story.</p>

<h2>Thought on Remembering the Kanji 1</h2>

<p>TL;DR It really works if you understand the point of the book.</p>

<p>Well, &ldquo;Remembering the Kanji 1&rdquo; can be awesome or overpriced worthless book depending on how do you understand the point of the book.</p>

<p>The keywords and the name of radicals can be very difficult especially for non-native English speaker like me. During the study, I always need an English dictionary. It is utterly mysterious how Heisig comes up with those keywords and few keywords are incorrect. If you try to judge the book from these, it is probably worthless for you. However, these are not the main point the book try to teach you.</p>

<p>The point of the book is simply to make you get used to those Kanji and establish a foundation for learning new Kanji in the future. The implication of this is learning Kanji is individual matter. It is very important to understand this. That means you can disagree with him. You can modify the keywords that suits yourself, probably in your own native language. You can group some radicals and name it if you think that it makes your life easier. These are what make this book awesome.</p>

<p>The mnemonic method works for me. Story will guide you how to write including the meaning. There is a certain thing I should emphasize. Heisig wants you to use &ldquo;imaginative memory&rdquo;. You are to create stories to &ldquo;impress&rdquo; yourself. Impression on the stories will allow you to remember and recall things much easier as it comes out from your imagination. However, you still need a consistent review to. By the time, the story will eventually fade away but you still know how to write those Kanji.</p>

<p>Regarding reviewing, Heisig suggests to review from keywords because you will review both writing and recognizing the Kanji at the same time. To me this is partial true. I sometimes have problem of recalling the meaning because of keywords that I am not familiar with. It may also be may fault that I don&rsquo;t know English vocabularies enough. However, I tend to be able to recall when I encounter them again.</p>

<p>It is not perfect but it works pretty well.</p>

<h2>Studying with Remembering the Kanji</h2>

<p>It is dangerous to travel alone. Going through RTK1 on your own will pretty tedious. Here are things I recommend:</p>

<ul>
<li><p><a href="http://ankisrs.net/" title="Anki">Anki</a>: Anki is a SRS flashcard application. This is the killer application for those who study languages. It will assist you studying and reviewing.</p></li>
<li><p><a href="https://ankiweb.net/shared/info/2756278936" title="RTK1 6th deck">RTK1 6th pre-storied deck</a>: The stories are from a community site for RTK named <a href="http://forum.koohii.com/" title="Reviewing the Kanji">Reviewing the Kanji</a> You will import this deck to your Anki.</p></li>
</ul>


<p>Using the pre-storied to study doesn&rsquo;t mean you are going to solely remember those stories. Many of pre-storied in the deck are good enough in my opinion. What you have to do is to read the stories, appreciate them and embrace them with vivid imagination. Don&rsquo;t forget you can disagree with those pre-stories. If you don&rsquo;t like it, just create your own. As mentioned earlier, it is individual business.</p>

<p>Well, what kind of story should you make? I would say any kind as long as you love it. Your stories may be based movies, novels, comics, religions, politics, your own experiences, your friends&#8217; stories, etc. The key is to create stories that you make yourself enjoy learning.</p>

<p>You are going to study every day. I recommend not to study more than 20 Kanji a day. The more you try to study for each day, the longer time you are going to spend on reviewing. Moreover, studying too fast may reduce your recalling ability; this is from my own experience. At this study rate, you should be able to finish RTK1 in 3 months and a half. However, it is recommend you find you own &ldquo;<a href="http://www.tofugu.com/2013/08/02/your-minimum-effective-dose-of-learning-japanese/" title="Minimal Effective Dose">Minimal Effect Dose (MED)</a>&rdquo;. Find you own study rate such that you feel comfortable. The more you study isn&rsquo;t always better.</p>

<p>My preferred Anki settings for RTK1 is not to introduce new card automatically. I found that reviewing first and then study the new separately is better for me. With this setting, when I don&rsquo;t feel like I am ready to study new Kanji, I can skip the new.</p>

<p>The reason I recommend you to use Anki is that it will schedule the review for you according to your performance. It works flawlessly from my experience. However, you need to be honest during the review. If you completely forget a Kanji, it is good to re-study it again. During the review, it is good to write Kanji characters onto a paper. I know that nowadays we have computers. However, you should prepare for the situation that it does not exist.</p>

<h2>Final thought</h2>

<p>One thing that you must understand about learning Kanji is that it is going to take a long time. I want you to keep in mind that your Kanji journey is not end yet after you finish the book. There are a lot of things left to learn. RTK1 is just the beginning. The key to success is that you need to be consistent in you study and stayed motivated.</p>

<p>The next question is what to do next after finishing RTK1? For me, I don&rsquo;t plan to continue RTK2 and RTK3 yet. I think that the best way to learn a language is to get used to it. It is better to continue on vocabularies, learn how to pronounce and use them; Kanji will serve as another ABC for them. After this, the more you get yourself in to Japanese, the better you are.</p>

<p>It takes time. Don&rsquo;t worry if you feel exhausted but never give up.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/page//page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2015/04/17/remap-capslock-to-ctrl-on-freebsd/">Remap CAPSLOCK to CTRL on FreeBSD</a>
      </li>
    
      <li class="post">
        <a href="/2015/02/04/seeing-all-pages-available-in-section-9-on-freebsd/">Seeing All Man Pages Available in a Section on FreeBSD</a>
      </li>
    
      <li class="post">
        <a href="/2014/11/04/verify-openbsd-install-media-from-os-x/">Verifing OpenBSD Install Media on OS X</a>
      </li>
    
      <li class="post">
        <a href="/2014/07/04/digging-around-freebsd-socket-api-tcp-send-path/">Digging Around FreeBSD Socket API TCP Send Path</a>
      </li>
    
      <li class="post">
        <a href="/2013/09/20/thought-on-learning-kanji-with-remembering-the-kanji/">Thought on Learning Kanji With Remembering the Kanji</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Ake Koomsin -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
