
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ake Koomsin</title>
  <meta name="author" content="Ake Koomsin">

  
  <meta name="description" content="It has been for a while since my last post. I was enjoying with my senior project, &ldquo;Accelerating Map Rendering with GPU&rdquo;. In this project &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ake.in.th/page//page/2">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ake Koomsin" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Ake Koomsin</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ake.in.th" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
      <h1 class="entry-title"><a href="/2013/04/02/offscreening-and-multisampling-with-opengl/">Offscreen Rendering and Multisampling With OpenGL</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2013-04-02T17:10:00+09:00" pubdate data-updated="true">Apr 2<span>nd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It has been for a while since my last post. I was enjoying with my senior project, &ldquo;Accelerating Map Rendering with GPU&rdquo;. In this project, my friend and I modified Mapnik, an opensource map rendering, to utilize Nvidia&rsquo;s <a href="https://developer.nvidia.com/nv-path-rendering" title="Nvidia's Path Rendering">Path Rendering</a>. Path Rendering is an OpenGL extension provided by Nvidia for vector graphic rendering. Nvidia <a href="http://dl.acm.org/citation.cfm?id=2366191" title="GPU-accelerated path rendering paper">claims</a> that its extensions aims to reduce overhead from traditional APIs when using them to draw vector graphics. In the end, we are able to make the map production 30-60% faster. Our implementation can be found on <a href="https://github.com/ake-koomsin/mapnik_nvpr">https://github.com/ake-koomsin/mapnik_nvpr</a></p>

<p>There are two important things that we had to achieve in order to use Path Rendering extension for map rendering, offscreen rendering and multisampling. Offscreen rendering is important because we don&rsquo;t want the renderer to show the intermediate result. Multisampling is for producing a quality map.</p>

<p>I think offscreen rendering combining with multisampling is an important piece of knowledge. It is also hard to find a complete refernce about these two. Therefore, I think it is worth writing about it.</p>

<h2>Offscreen Rendering</h2>

<p>Offscreen rendering is a technique that are commonly found in game development. Sometimes, there are situations that you want to generate a texture at runtime.</p>

<p>To set up offscreen rendering, you have to create your own &ldquo;Framebuffer Object (FBO)&rdquo;. Actually, OpenGL has its own default FBO. A result stored in the default FBO will be shown onto the screen while the result stored in our own FBO will be not. The code below demonstrates how to set up our own FBO.</p>

<figure class='code'><figcaption><span>Setting our own FBO for offscreen rendering</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="n">fbo</span><span class="p">,</span> <span class="n">colorBuffer</span><span class="p">,</span> <span class="n">depthBuffer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create and bind the FBO</span>
</span><span class='line'><span class="n">glGenFramebuffers</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbo</span><span class="p">);</span>
</span><span class='line'><span class="n">glBindFramebuffer</span><span class="p">(</span><span class="n">GL_FRAMEBUFFER</span><span class="p">,</span> <span class="n">fbo</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create color render buffer</span>
</span><span class='line'><span class="n">glGenRenderbuffers</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">colorBuffer</span><span class="p">);</span>
</span><span class='line'><span class="n">glBindRenderbuffer</span><span class="p">(</span><span class="n">GL_RENDERBUFFER</span><span class="p">,</span> <span class="n">colorBuffer</span><span class="p">);</span>
</span><span class='line'><span class="n">glRenderbufferStorage</span><span class="p">(</span><span class="n">GL_RENDERBUFFER</span><span class="p">,</span> <span class="n">GL_RGBA8</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
</span><span class='line'><span class="n">glFramebufferRenderbuffer</span><span class="p">(</span><span class="n">GL_FRAMEBUFFER</span><span class="p">,</span> <span class="n">GL_COLOR_ATTACHMENT0</span><span class="p">,</span> <span class="n">GL_RENDERBUFFER</span><span class="p">,</span> <span class="n">colorBuffer</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create depth render buffer (This is optional)</span>
</span><span class='line'><span class="n">glGenRenderbuffers</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">depthBuffer</span><span class="p">);</span>
</span><span class='line'><span class="n">glBindRenderbuffer</span><span class="p">(</span><span class="n">GL_RENDERBUFFER</span><span class="p">,</span> <span class="n">depthBuffer</span><span class="p">);</span>
</span><span class='line'><span class="n">glRenderbufferStorage</span><span class="p">(</span><span class="n">GL_RENDERBUFFER</span><span class="p">,</span> <span class="n">GL_DEPTH24_STENCIL8</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
</span><span class='line'><span class="n">glFramebufferRenderbuffer</span><span class="p">(</span><span class="n">GL_FRAMEBUFFER</span><span class="p">,</span> <span class="n">GL_DEPTH_ATTACHMENT</span><span class="p">,</span> <span class="n">GL_RENDERBUFFER</span><span class="p">,</span> <span class="n">depthBuffer</span><span class="p">);</span>
</span><span class='line'><span class="n">glFramebufferRenderbuffer</span><span class="p">(</span><span class="n">GL_FRAMEBUFFER</span><span class="p">,</span> <span class="n">GL_STENCIL_ATTACHMENT</span><span class="p">,</span> <span class="n">GL_RENDERBUFFER</span><span class="p">,</span> <span class="n">depthBuffer</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Bind Texture assuming we have created a texture</span>
</span><span class='line'><span class="n">glFramebufferTexture2D</span><span class="p">(</span><span class="n">GL_FRAMEBUFFER</span><span class="p">,</span> <span class="n">GL_COLOR_ATTACHMENT0</span><span class="p">,</span> <span class="n">GL_TEXTURE_2D</span><span class="p">,</span> <span class="n">aTexture</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Draw something</span>
</span><span class='line'><span class="n">drawGraphic</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>It is straightforward. First, we create a FBO. After that, we create render buffers and textures and attach them to our FBO.</p>

<h2>Multisampling</h2>

<p>By default, OpenGL does not care about antialiasing. As a result, the output contains stair-like artifacts which degrade visual quality. We have to enable multisampling by the code below.</p>

<figure class='code'><figcaption><span>Enabling multisampling</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">glEanble</span><span class="p">(</span><span class="n">GL_MULTISAMPLE</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Combining Offscreen Rendering and Multisampling Together</h2>

<p>It turns out that to combine them together, we need additional set up which are multisample framebuffer storage and multisample texture. The code below demonstrates how to do.</p>

<figure class='code'><figcaption><span>Setting up FBO with Multisampling</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">// Create multisample texture</span>
</span><span class='line'><span class="n">glBindTexture</span><span class="p">(</span><span class="n">GL_TEXTURE_2D_MULTISAMPLE</span><span class="p">,</span> <span class="n">aMultisampleTexture</span><span class="p">);</span>
</span><span class='line'><span class="n">glTexImage2DMultisample</span><span class="p">(</span><span class="n">GL_TEXTURE_2D_MULTISAMPLE</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GL_RGBA</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">GL_TRUE</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">fbo</span><span class="p">,</span> <span class="n">colorBuffer</span><span class="p">,</span> <span class="n">depthBuffer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create and bind the FBO</span>
</span><span class='line'><span class="n">glGenFramebuffers</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fbo</span><span class="p">);</span>
</span><span class='line'><span class="n">glBindFramebuffer</span><span class="p">(</span><span class="n">GL_FRAMEBUFFER</span><span class="p">,</span> <span class="n">fbo</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create color render buffer</span>
</span><span class='line'><span class="n">glGenRenderbuffers</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">colorBuffer</span><span class="p">);</span>
</span><span class='line'><span class="n">glBindRenderbuffer</span><span class="p">(</span><span class="n">GL_RENDERBUFFER</span><span class="p">,</span> <span class="n">colorBuffer</span><span class="p">);</span>
</span><span class='line'><span class="n">glRenderbufferStorageMultisample</span><span class="p">(</span><span class="n">GL_RENDERBUFFER</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GL_RGBA8</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
</span><span class='line'><span class="n">glFramebufferRenderbuffer</span><span class="p">(</span><span class="n">GL_FRAMEBUFFER</span><span class="p">,</span> <span class="n">GL_COLOR_ATTACHMENT0</span><span class="p">,</span> <span class="n">GL_RENDERBUFFER</span><span class="p">,</span> <span class="n">colorBuffer</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create depth render buffer (This is optional)</span>
</span><span class='line'><span class="n">glGenRenderbuffers</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">depthBuffer</span><span class="p">);</span>
</span><span class='line'><span class="n">glBindRenderbuffer</span><span class="p">(</span><span class="n">GL_RENDERBUFFER</span><span class="p">,</span> <span class="n">depthBuffer</span><span class="p">);</span>
</span><span class='line'><span class="n">glRenderbufferStorageMultisample</span><span class="p">(</span><span class="n">GL_RENDERBUFFER</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GL_DEPTH24_STENCIL8</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
</span><span class='line'><span class="n">glFramebufferRenderbuffer</span><span class="p">(</span><span class="n">GL_FRAMEBUFFER</span><span class="p">,</span> <span class="n">GL_DEPTH_ATTACHMENT</span><span class="p">,</span> <span class="n">GL_RENDERBUFFER</span><span class="p">,</span> <span class="n">depthBuffer</span><span class="p">);</span>
</span><span class='line'><span class="n">glFramebufferRenderbuffer</span><span class="p">(</span><span class="n">GL_FRAMEBUFFER</span><span class="p">,</span> <span class="n">GL_STENCIL_ATTACHMENT</span><span class="p">,</span> <span class="n">GL_RENDERBUFFER</span><span class="p">,</span> <span class="n">depthBuffer</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Bind Texture assuming we have created a texture</span>
</span><span class='line'><span class="n">glFramebufferTexture2D</span><span class="p">(</span><span class="n">GL_FRAMEBUFFER</span><span class="p">,</span> <span class="n">GL_COLOR_ATTACHMENT0</span><span class="p">,</span> <span class="n">GL_TEXTURE_2D</span><span class="p">,</span> <span class="n">aTexture</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Enable multisampling</span>
</span><span class='line'><span class="n">glEanble</span><span class="p">(</span><span class="n">GL_MULTISAMPLE</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Draw something</span>
</span><span class='line'><span class="n">drawGraphic</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Retrieving the result</h2>

<p>After offscreen rendering, you may want to display the result onto the screen. When you are using multisampling FBO, you are not able to use the result stored in the texture directly. You have to do &ldquo;Blitting&rdquo; which transfer the result from one FBO to another. The code below shows how to do.</p>

<figure class='code'><figcaption><span>Blitting</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">glBindFramebuffer</span><span class="p">(</span><span class="n">GL_READ_FRAMEBUFFER</span><span class="p">,</span> <span class="n">multisampledFBO</span><span class="p">);</span>
</span><span class='line'><span class="n">glBindFramebuffer</span><span class="p">(</span><span class="n">GL_DRAW_FRAMEBUFFER</span><span class="p">,</span> <span class="n">normalFBO</span><span class="p">);</span> <span class="c1">// Normal FBO can be the default FBO too.</span>
</span><span class='line'><span class="n">glBlitFramebuffer</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">GL_COLOR_BUFFER_BIT</span><span class="p">,</span> <span class="n">GL_NEAREST</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>I hope these snippets are a useful reference.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
      <h1 class="entry-title"><a href="/2012/11/17/my-first-kernel-extension-for-logitech-presenter-device/">My First Kernel Extension for Logitech Presenter Device</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2012-11-17T14:36:00+09:00" pubdate data-updated="true">Nov 17<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I do a lot of presentation particularly those class projects. To make my presentation looks more professional, I decide to buy <a href="http://www.logitech.com/en-us/mice-pointers/presenter/professional-presenter-r800">Logitech Professional Presenter R800</a>. It is very nice. I recommend you to have one if you have to give a lot of presentation.</p>

<p>However, what bothers me is that not all buttons work with Apple Keynote, particularly Play button and Blank button. Well, the device is designed for Microsoft PowerPoint on Windows.</p>

<p>The questions are why it doesn&rsquo;t work and how to make it works with Keynote?</p>

<h2>How does the device work?</h2>

<p>Actually, that device is merely a wireless keyboard with only 4 keys including, Page Up, Page Down, F5 and . (dot). Page Up key and Page Down key are for moving slides back and forth. F5 is for starting a presentation. Dot key is for blanking.</p>

<p>PowerPoint conforms to all those keys but Keynote doesn&rsquo;t. Keynote uses, by default, CMD + ALT + P to start playing a slide and B for blanking the slide. Dot key for Keynote is for terminating the slideshow which may or may not what you want.</p>

<h2>What normal people would do</h2>

<p>The simple and sane way is to modify the shortcut key. You can go to System Preference > Keyboard > Keyboard Shortcuts > Application Shortcuts, add Keynote application and overide Play Slideshow to use F5. However, This approach doesn&rsquo;t work if you want to modify the Blank key.</p>

<p>You can ignore Blank key actually if you want it to stop playing the slide but I want to blank the screen. To me, stop playing to the slide means the presentation is end and I will be at the computer to stop the slideshow manually.</p>

<h2>What I actually do</h2>

<p>To satify my geek spirit, I write my own kernel extension for the device.</p>

<p>The first question is where should I start? The answer is <code>ioreg</code>. I know that the device is a keyboard. Keyboard is a kind of Human Interface Device (HID). Apple Keyboard is also a keyboard. Therefore, I should take a look at driver which is used with Apple Keyboard.</p>

<p>Before I go, I should mention a little bit about IOKit Framework first. IOKit Framework is a framework that Apple provides to developers for writing a device driver in an OOP way wtih C++.</p>

<p>The belowing snippet shows the partial output from <code>ioreg</code>:</p>

<figure class='code'><figcaption><span>ioreg output</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>...
</span><span class='line'>| |   |   +-o Apple Internal Keyboard / Trackpad@4600000  &lt;class IOUSBDevice, id 0x100000292, registered, matched, active, busy 0 (1173 ms), r$
</span><span class='line'>    | |   |     +-o IOUSBCompositeDriver  &lt;class IOUSBCompositeDriver, id 0x100000295, !registered, !matched, active, busy 0, retain 4&gt;
</span><span class='line'>    | |   |     +-o Apple Internal Keyboard@0  &lt;class IOUSBInterface, id 0x100000296, registered, matched, active, busy 0 (213 ms), retain 9&gt;
</span><span class='line'>    | |   |     | +-o AppleUSBTCKeyboard  &lt;class AppleUSBTCKeyboard, id 0x10000029a, registered, matched, active, busy 0 (33 ms), retain 12&gt;
</span><span class='line'>    | |   |     |   +-o IOHIDInterface  &lt;class IOHIDInterface, id 0x10000029f, registered, matched, active, busy 0 (31 ms), retain 7&gt;
</span><span class='line'>    | |   |     |   | +-o AppleEmbeddedKeyboard  &lt;class AppleEmbeddedKeyboard, id 0x1000002a0, registered, matched, active, busy 0 (0 ms), retain $
</span><span class='line'>    | |   |     |   |   +-o IOHIDKeyboard  &lt;class IOHIDKeyboard, id 0x1000002a2, registered, matched, active, busy 0 (0 ms), retain 8&gt;
</span><span class='line'>    | |   |     |   |   | +-o IOHIDSystem  &lt;class IOHIDSystem, id 0x1000002ac, registered, matched, active, busy 0 (0 ms), retain 20&gt;
</span><span class='line'>    | |   |     |   |   |   +-o IOHIDStackShotUserClient  &lt;class IOHIDStackShotUserClient, id 0x10000035d, !registered, !matched, active, busy 0, $
</span><span class='line'>    | |   |     |   |   |   +-o IOHIDUserClient  &lt;class IOHIDUserClient, id 0x100000371, !registered, !matched, active, busy 0, retain 5&gt;
</span><span class='line'>    | |   |     |   |   |   +-o IOHIDParamUserClient  &lt;class IOHIDParamUserClient, id 0x100000385, !registered, !matched, active, busy 0, retain 5$
</span><span class='line'>    | |   |     |   |   |   +-o IOHIDEventSystemUserClient  &lt;class IOHIDEventSystemUserClient, id 0x1000003c1, !registered, !matched, active, busy$
</span><span class='line'>    | |   |     |   |   |   +-o IOHIDEventSystemUserClient  &lt;class IOHIDEventSystemUserClient, id 0x1000003c9, !registered, !matched, active, busy$
</span><span class='line'>    | |   |     |   |   +-o IOHIDConsumer  &lt;class IOHIDConsumer, id 0x1000002a3, registered, matched, active, busy 0 (0 ms), retain 8&gt;
</span><span class='line'>    | |   |     |   |   | +-o IOHIDSystem  &lt;class IOHIDSystem, id 0x1000002ac, registered, matched, active, busy 0 (0 ms), retain 20&gt;
</span><span class='line'>    | |   |     |   |   |   +-o IOHIDStackShotUserClient  &lt;class IOHIDStackShotUserClient, id 0x10000035d, !registered, !matched, active, busy 0, $
</span><span class='line'>    | |   |     |   |   |   +-o IOHIDUserClient  &lt;class IOHIDUserClient, id 0x100000371, !registered, !matched, active, busy 0, retain 5&gt;
</span><span class='line'>    | |   |     |   |   |   +-o IOHIDParamUserClient  &lt;class IOHIDParamUserClient, id 0x100000385, !registered, !matched, active, busy 0, retain 5$
</span><span class='line'>    | |   |     |   |   |   +-o IOHIDEventSystemUserClient  &lt;class IOHIDEventSystemUserClient, id 0x1000003c1, !registered, !matched, active, busy$
</span><span class='line'>    | |   |     |   |   |   +-o IOHIDEventSystemUserClient  &lt;class IOHIDEventSystemUserClient, id 0x1000003c9, !registered, !matched, active, busy$
</span><span class='line'>    | |   |     |   |   +-o IOHIDSystem  &lt;class IOHIDSystem, id 0x1000002ac, registered, matched, active, busy 0 (0 ms), retain 19&gt;
</span><span class='line'>    | |   |     |   |     +-o IOHIDStackShotUserClient  &lt;class IOHIDStackShotUserClient, id 0x10000035d, !registered, !matched, active, busy 0, re$
</span><span class='line'>    | |   |     |   |     +-o IOHIDUserClient  &lt;class IOHIDUserClient, id 0x100000371, !registered, !matched, active, busy 0, retain 5&gt;
</span><span class='line'>    | |   |     |   |     +-o IOHIDParamUserClient  &lt;class IOHIDParamUserClient, id 0x100000385, !registered, !matched, active, busy 0, retain 5&gt;
</span><span class='line'>    | |   |     |   |     +-o IOHIDEventSystemUserClient  &lt;class IOHIDEventSystemUserClient, id 0x1000003c1, !registered, !matched, active, busy 0$
</span><span class='line'>    | |   |     |   |     +-o IOHIDEventSystemUserClient  &lt;class IOHIDEventSystemUserClient, id 0x1000003c9, !registered, !matched, active, busy 0$
</span><span class='line'>    | |   |     |   +-o IOHIDLibUserClient  &lt;class IOHIDLibUserClient, id 0x1000003c7, !registered, !matched, active, busy 0, retain 6&gt;
</span><span class='line'>    | |   |     |   +-o IOHIDLibUserClient  &lt;class IOHIDLibUserClient, id 0x10000044b, !registered, !matched, active, busy 0, retain 6&gt;
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>What does this information tell us? It shows the hierarchy of drivers which implys us the chain of command. For example, IOHIDInterface is said to be a provider of AppleEmbeddedKeyboard; you can think of it as a data provider.</p>

<p>The class beginning with IO belongs to the system. As you can see, there are 2 custom drivers, AppleUSBTCKeyboard and AppleEmbeddedKeyboard. I investigate further by the command <code>ioreg -c</code> and find out that AppleUSBTCKeyboard is a subclass of IOUSBHIDDriver and AppleEmbeddedKeyboard is a subclass of IOHIDEventDriver.</p>

<p>My initial assumption about the driver is that it should do something about event dispatching. I start by looking at IOUSBHIDDriver.h and IOHIDEventDriver.h and found nothing that seems to match my assumption. Is my assumption wrong?</p>

<p>I google &lsquo;AppleEmbeddedKeyboard&rsquo; and find a source code from Apple open source repository. I take a look at AppleEmbeddedKeyboard.cpp find this method overiding interesting:</p>

<figure class='code'><figcaption><span>dispatchKeyboardEvent method</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="kt">void</span> <span class="n">AppleEmbeddedKeyboard</span><span class="o">::</span><span class="n">dispatchKeyboardEvent</span><span class="p">(</span>
</span><span class='line'>                                <span class="n">AbsoluteTime</span>                <span class="n">timeStamp</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">UInt32</span>                      <span class="n">usagePage</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">UInt32</span>                      <span class="n">usage</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">UInt32</span>                      <span class="n">value</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">IOOptionBits</span>                <span class="n">options</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It turns out that the method <code>dispatchKeyboardEvent()</code> is declared in IOHIDEventService.h. So, I decide to write the kernel extension based on IOHIDEventDriver. With Apple documentation and suggestion from Pavel Prokofiev who writes <a href="http://code.google.com/p/macosx-nosleep-extension/">macosx-nosleep-extension</a>, I am able to complete it (It is not that hard but takes time to understand what things are).</p>

<p>What my code does is intercepting the key and replace it if necessary.</p>

<p>You can see my source code here <a href="https://github.com/ake-koomsin/LogitechWirelessPresenterKext">https://github.com/ake-koomsin/LogitechWirelessPresenterKext</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
      <h1 class="entry-title"><a href="/2012/04/11/thought-on-writing-a-report-with-latex/">Thought on Writing a Report With LaTeX</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2012-04-11T12:23:00+09:00" pubdate data-updated="true">Apr 11<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;m not dead!</p>

<p>I haven&rsquo;t update my blog for a month becasue I really have no time. I had to study from 8:40 to 17:20 every day due to the great flood. Agh! I hate school time.</p>

<p>I just finished my final exams yesterday. I feel really great now, just like getting out of the jail.</p>

<p>Let&rsquo;s come back to the story about Latex.</p>

<p>I had to write a software architecture document as an assignment. My teacher provided me a Microsoft Word template but it looks suck. Therefore, I decided to write from scratch with LaTeX.</p>

<p>I had to install MacTeX for Lion. Its size was pretty large in my opinion but that was fine. I downloaded TeXShop 3.04 for Lion to use as a LaTeX editor.</p>

<p>To me, writing a report with LaTeX is like writing a HTML page. I just specify chapters and sections that I am going to have and provide their content. LaTeX will take care of the output for you and it is just beautiful. I see the semantics in my source file.</p>

<p>LaTeX is easy until you want to customize something.</p>

<p>To customize something, I found that I had to use extra packages and had to read its document which was not quite productive at the beginning.</p>

<p>Things became more complicated when I had to deal wtih table layout. I would say that it was very challeging. I took a lot of time to figure out how to get the table layout I want. However, I felt like I was using table the wrong way so that it was complicated.</p>

<p>To be honest, I&rsquo;m still not be able to remember all the essential commands in LaTeX. I just open the documentation when I need.</p>

<p>Anyway, It was fun and I will continue using it for sure.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
      <h1 class="entry-title"><a href="/2012/01/21/install-outguess-on-os-x-lion-with-homebrew/">Install Outguess on OS X Lion With Homebrew</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2012-01-21T20:36:00+09:00" pubdate data-updated="true">Jan 21<span>st</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In my security and cryptography class, My teacher showed me an interesting program called outguess. What it does it hide a plain text into a jpg file. This method is known as steganography.</p>

<p>The program will read an input text file and slightly change pixels color in the image in such the way that it is not going to be visible.</p>

<p>Here is an example of putting some text into an image:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>outguess -d some_text.txt image.jpg image_result.jpg
</span></code></pre></td></tr></table></div></figure>


<p>Here is how to extract text from the image:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>outguess -r image_result.jpg hidden_text.txt
</span></code></pre></td></tr></table></div></figure>


<p>Here is how to install outguess with homebrew. Firstly, we need to create a formula.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew create http://www.outguess.org/outguess-0.2.tar.gz
</span><span class='line'>brew edit outguess
</span></code></pre></td></tr></table></div></figure>


<p>Then, modify the outguess formula like this</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;formula&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Outguess</span> <span class="o">&lt;</span> <span class="no">Formula</span>
</span><span class='line'>  <span class="n">homepage</span> <span class="s1">&#39;http://www.outguess.org/&#39;</span>
</span><span class='line'>  <span class="n">url</span> <span class="s1">&#39;http://www.outguess.org/outguess-0.2.tar.gz&#39;</span>
</span><span class='line'>  <span class="n">mirror</span> <span class="s1">&#39;http://www.mirrors.wiretapped.net/security/steganography/outguess/outguess-0.2.tar.gz&#39;</span>
</span><span class='line'>  <span class="n">md5</span> <span class="s1">&#39;321f23dc0badaba4350fa66b59829064&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">install</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Segmentation fault occurs if compiling with clang, use llvm-gcc instead</span>
</span><span class='line'>    <span class="no">ENV</span><span class="o">.</span><span class="n">gcc</span> <span class="ss">:force</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">args</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;--disable-debug&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s2">&quot;--disable-dependency-tracking&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s2">&quot;--prefix=</span><span class="si">#{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s2">&quot;--sysconfdir=</span><span class="si">#{</span><span class="n">etc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s2">&quot;--mandir=</span><span class="si">#{</span><span class="n">man</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>            <span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">system</span> <span class="s2">&quot;./configure&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span>
</span><span class='line'>    <span class="nb">system</span> <span class="s2">&quot;make&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">bin</span><span class="o">.</span><span class="n">install</span> <span class="s2">&quot;outguess&quot;</span>
</span><span class='line'>    <span class="n">man1</span><span class="o">.</span><span class="n">install</span> <span class="s2">&quot;outguess.1&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And that&rsquo;s it. In order to install:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew install outguess
</span></code></pre></td></tr></table></div></figure>


<p>I actually pull-requested to homebrew main repository. However, the maintainers don&rsquo;t want a formula that is not clang compatible because llvm-gcc is going away. I agreed with them. Even though there is a successor of llvm-gcc, DragonEgg, we still don&rsquo;t know its future and keeping clang-incompatible formula away from main repository make the repository clean. If I have time, I think I will take a look at the source code and creating a patch. Noteing that this program seems to be no longer maintained.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <!-- Now we're back to normal posts. Note the links used under href in both headers.-->
      <h1 class="entry-title"><a href="/2012/01/04/using-date-command-in-cron-job/">Using Date Command in Cron Job</a></h1>
      
    
    
      <p class="meta">
        








  


<time datetime="2012-01-04T21:26:00+09:00" pubdate data-updated="true">Jan 4<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I had to set a cron job to back up mysql database and its format I wanted is like this</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>back_up_YYYY_MM_DD.sql</span></code></pre></td></tr></table></div></figure>


<p>And here was my first initial configuration that I added to <code>/etc/crontab</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>00 11   * * *   a_user   mysqldump -u root -pSomePass db &gt; /home/a_user/www/sql_backup/back_up_<span class="sb">`</span>date +%Y_%d_%m<span class="sb">`</span>.sql
</span></code></pre></td></tr></table></div></figure>


<p>Actually, I noticed a strange syntax color at the end of the line in Vim. I thought it is just misparsing so that I ommited it.</p>

<p>And here was the output in <code>/var/log/syslog</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Jan  4 11:00:01 a_user CRON<span class="o">[</span>3427<span class="o">]</span>: <span class="o">(</span>a_user<span class="o">)</span> CMD <span class="o">(</span>  mysqldump -u root -pSomePass db &gt; /home/a_user/www/sql_backup/back_up_<span class="sb">`</span>date +<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Something was wrong as you can see; it was not complete.</p>

<p>In order to fix this, I had to escape the &lsquo;%&rsquo; sign</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>00 11   * * *   a_user   mysqldump -u root -pSomePass db &gt; /home/gizmo/www/sql_backup/back_up_<span class="sb">`</span>date +<span class="se">\%</span>Y_<span class="se">\%</span>d_<span class="se">\%</span>m<span class="sb">`</span>.sql
</span></code></pre></td></tr></table></div></figure>


<p>Now, everything works fine :D</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/page//page/3/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2014/11/22/memory-mapping-in-kernel-space-on-freebsd/">Memory Mapping in Kernel Space on FreeBSD</a>
      </li>
    
      <li class="post">
        <a href="/2014/11/04/verify-openbsd-install-media-from-os-x/">Verifing OpenBSD Install Media on OS X</a>
      </li>
    
      <li class="post">
        <a href="/2014/07/04/digging-around-freebsd-socket-api-tcp-send-path/">Digging Around FreeBSD Socket API TCP Send Path</a>
      </li>
    
      <li class="post">
        <a href="/2013/09/20/thought-on-learning-kanji-with-remembering-the-kanji/">Thought on Learning Kanji With Remembering the Kanji</a>
      </li>
    
      <li class="post">
        <a href="/2013/04/17/building-facebook-home-with-quartz-composer/">Building Facebook Home With Quartz Composer</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Ake Koomsin -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
